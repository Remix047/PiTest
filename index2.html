<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>One PI - Lotería Pi Network</title>
  <!-- Incluir el SDK de Pi -->
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
  <script>
    // Inicializar el SDK de Pi
    Pi.init({ version: "2.0" sandbox: true });
  </script>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      background-color: #f4f4f9;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    .container {
      background-color: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      text-align: center;
      max-width: 400px;
      width: 100%;
      animation: fadeIn 1s ease-in-out;
    }
    h1 {
      color: #333;
    }
    .hidden {
      display: none;
    }
    label, select, button {
      font-size: 1rem;
      margin: 10px 0;
    }
    button {
      background-color: #007bff;
      color: #fff;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #0056b3;
    }
    footer {
      margin-top: 20px;
    }
    footer a {
      color: #007bff;
      text-decoration: none;
      margin: 0 10px;
    }
    footer a:hover {
      text-decoration: underline;
    }
    .network-status {
      margin-top: 10px;
      font-weight: bold;
    }
    .network-status.active {
      color: green;
    }
    .network-status.inactive {
      color: red;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>One PI - Lotería Pi Network</h1>

    <!-- Indicador de red -->
    <div class="network-status" id="network-status">
      Red: <span id="network-type">Cargando...</span>
    </div>

    <!-- Sección de autenticación -->
    <div id="auth">
      <button id="btn-auth">Autenticar con Pi</button>
    </div>

    <!-- Sección del juego (oculta hasta autenticación) -->
    <div id="game" class="hidden">
      <p>Bienvenido, <span id="username"></span></p>
      <div>
        <label for="number">Elige un número (1-10): </label>
        <select id="number">
          <!-- Se llenará dinámicamente -->
        </select>
      </div>
      <button id="btn-play">Jugar (Pagar 1 Pi)</button>
      <p id="result"></p>
      <hr>
      <p>Saldo acumulado: <span id="balance">0</span> Pi</p>
      <button id="btn-claim">Reclamar saldo</button>
      <button id="btn-logout">Cerrar sesión</button>
    </div>
    <footer>
      <a href="terms.html" target="_blank">Términos de Uso</a> |
      <a href="privacy.html" target="_blank">Política de Privacidad</a>
    </footer>
  </div>

  <script>
    // Rellenar el select con números del 1 al 10
    const selectElem = document.getElementById('number');
    for (let i = 1; i <= 10; i++) {
      const option = document.createElement('option');
      option.value = i;
      option.text = i;
      selectElem.appendChild(option);
    }

    let currentUser = null;
    let balance = 0;
    let balanceTimestamp = null; // Marca de tiempo cuando se acreditó el primer saldo

    // Funciones para gestionar el saldo usando localStorage
    function loadBalance() {
      const storedBalance = localStorage.getItem('piLotteryBalance');
      const storedTimestamp = localStorage.getItem('piLotteryTimestamp');
      if (storedBalance) {
        balance = parseFloat(storedBalance);
      }
      if (storedTimestamp) {
        balanceTimestamp = parseInt(storedTimestamp);
      }
      updateBalanceDisplay();
    }

    function updateBalanceDisplay() {
      document.getElementById('balance').innerText = balance.toFixed(2);
    }

    function saveBalance() {
      localStorage.setItem('piLotteryBalance', balance);
      if (!balanceTimestamp) {
        balanceTimestamp = Date.now();
        localStorage.setItem('piLotteryTimestamp', balanceTimestamp);
      }
    }

    // Función para verificar la red (Mainnet o Testnet)
    function updateNetworkStatus() {
      const networkType = Pi.sandbox ? "Testnet" : "Mainnet";
      const networkStatusElem = document.getElementById('network-status');
      const networkTypeElem = document.getElementById('network-type');
      networkTypeElem.innerText = networkType;
      if (Pi.sandbox) {
        networkStatusElem.classList.remove('active');
        networkStatusElem.classList.add('inactive');
      } else {
        networkStatusElem.classList.remove('inactive');
        networkStatusElem.classList.add('active');
      }
    }

    // Manejo de autenticación
    document.getElementById('btn-auth').addEventListener('click', function() {
      const scopes = ['payments'];
      // Callback opcional para pagos incompletos
      function onIncompletePaymentFound(payment) {
        console.log("Pago incompleto encontrado:", payment);
        // Manejar pagos incompletos según la lógica de tu aplicación
      }
      Pi.authenticate(scopes, onIncompletePaymentFound)
        .then(function(auth) {
          currentUser = auth.user;
          document.getElementById('username').innerText = currentUser.username || "Usuario";
          document.getElementById('auth').classList.add('hidden');
          document.getElementById('game').classList.remove('hidden');
          loadBalance();
        })
        .catch(function(error) {
          console.error("Error de autenticación:", error);
          alert("Error de autenticación: " + error.message);
        });
    });

    // Manejo del juego
    document.getElementById('btn-play').addEventListener('click', function() {
      if (balance < 1) {
        alert("No tienes fondos suficientes para jugar.");
        return;
      }

      const selectedNumber = parseInt(selectElem.value);
      const paymentData = {
        amount: 1,
        memo: `Juego de lotería - Número seleccionado: ${selectedNumber}`,
        metadata: { number: selectedNumber }
      };

      Pi.createPayment(paymentData)
        .then(function(payment) {
          console.log("Pago exitoso:", payment);
          const randomNumber = Math.floor(Math.random() * 10) + 1;
          if (selectedNumber === randomNumber) {
            balance += 10; // Premio por acertar
            document.getElementById('result').innerText = "¡Ganaste! Has acertado el número.";
          } else {
            document.getElementById('result').innerText = `Perdiste. El número ganador era ${randomNumber}.`;
          }
          saveBalance();
          updateBalanceDisplay();
        })
        .catch(function(error) {
          console.error("Error en el pago:", error);
          alert("Error en el pago: " + error.message);
        });
    });

    // Manejo de reclamación de saldo
    document.getElementById('btn-claim').addEventListener('click', function() {
      if (balance > 0) {
        const paymentData = {
          amount: balance,
          memo: "Reclamación de saldo acumulado",
          metadata: { action: "claim" }
        };

        Pi.createPayment(paymentData)
          .then(function(payment) {
            console.log("Pago de reclamación exitoso:", payment);
            balance = 0;
            saveBalance();
            updateBalanceDisplay();
            alert("Saldo reclamado con éxito.");
          })
          .catch(function(error) {
            console.error("Error en la reclamación:", error);
            alert("Error en la reclamación: " + error.message);
          });
      } else {
        alert("No tienes saldo para reclamar.");
      }
    });

    // Cerrar sesión
    document.getElementById('btn-logout').addEventListener('click', function() {
      Pi.logout();
      currentUser = null;
      document.getElementById('auth').classList.remove('hidden');
      document.getElementById('game').classList.add('hidden');
      alert("Sesión cerrada correctamente.");
    });

    // Cargar el saldo al iniciar la página
    loadBalance();
    // Actualizar el estado de la red
    updateNetworkStatus();
  </script>
</body>
</html>
