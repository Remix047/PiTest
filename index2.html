<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>App de Donación Pi</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f4f4;
      text-align: center;
      padding-top: 80px;
      margin: 0;
    }
    h1 {
      color: #333;
    }
    button {
      padding: 12px 25px;
      font-size: 16px;
      border: none;
      border-radius: 5px;
      margin: 10px;
      cursor: pointer;
    }
    #authButton {
      background-color: #28a745;
      color: white;
    }
    #donateButton {
      background-color: #007bff;
      color: white;
    }
    #donateButton:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <h1>Donación de 1 Pi</h1>
  <button id="authButton">Autenticarse</button>
  <button id="donateButton" disabled>Donar 1 Pi</button>

  <!-- Se incluyen los scripts del SDK según la documentación -->
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
  <script>
    // Inicializa el SDK (asegúrate de que este código se ejecute en el Pi Browser)
    Pi.init({ version: "2.0" });
  </script>
  <script>
    const authButton = document.getElementById('authButton');
    const donateButton = document.getElementById('donateButton');

    // Callback para pagos incompletos, opcional pero recomendado
    function onIncompletePaymentFound(payment) {
      console.log('Pago incompleto encontrado:', payment);
    }

    // Autenticación del usuario con el scope 'payments'
    authButton.addEventListener('click', () => {
      const scopes = ['payments'];
      Pi.authenticate(scopes, onIncompletePaymentFound)
        .then(function(auth) {
          console.log(`Hi there! You're ready to make payments!`, auth);
          alert("¡Autenticación exitosa!");
          // Habilita el botón de donación tras la autenticación
          donateButton.disabled = false;
        })
        .catch(function(error) {
          console.error("Error en autenticación:", error);
          alert("Error en autenticación: " + error.message);
        });
    });

    // Solicitar el pago (User-to-App) de 1 Pi
    donateButton.addEventListener('click', () => {
      Pi.createPayment({
          amount: 1, // Monto en π
          memo: "Donación de 1 Pi",
          metadata: {} // Puedes agregar información adicional aquí
      }, {
          onReadyForServerApproval: function(paymentId) {
              console.log("Listo para aprobación del servidor, paymentId:", paymentId);
              // En un entorno real, deberías enviar el paymentId a tu servidor
              // y esperar la aprobación para continuar. Aquí simulamos la aprobación:
              setTimeout(() => {
                // Simulamos el txid recibido desde el servidor
                const txid = "tx_simulado_123456";
                this.onReadyForServerCompletion(paymentId, txid);
              }, 2000);
          },
          onReadyForServerCompletion: function(paymentId, txid) {
              console.log("Pago completado, paymentId:", paymentId, "txid:", txid);
              alert("¡Donación completada!");
          },
          onCancel: function(paymentId) {
              console.log("Pago cancelado, paymentId:", paymentId);
              alert("Pago cancelado.");
          },
          onError: function(error, payment) {
              console.error("Error en el pago:", error, payment);
              alert("Error en el pago: " + error.message);
          }
      });
    });
  </script>
</body>
</html>
